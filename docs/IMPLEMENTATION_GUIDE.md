# 実装ガイド（実装記録・今後課題）

最終更新: 2026-02-25

このドキュメントは、現時点の実装状況・DB構成・既知課題・次の優先実装をまとめた開発ガイドです。  
新しい作業に着手する前に、まず本ページを確認してください。

## 1. 実装記録

### 1-1. ホームダッシュボード

- 左サイドバー（開閉対応）
  - メニュー: ホーム / 新規事案作成 / 事案検索 / 病院検索 / 設定
  - フッター: 救急隊名 + 隊ID表示
- メイン
  - 過去事案一覧テーブル
  - 「新規事案作成」ボタン
  - 行右端「詳細」ボタンから事案詳細へ遷移

### 1-2. 事案情報ページ（`/cases/new`, `/cases/[caseId]`）

- タブ構成
  - 基本情報
  - 概要_バイタル
  - 患者サマリー
  - 送信履歴
- 基本情報タブ（実装済み）
  - 氏名（不明トグル）
  - 性別（3種）
  - 生年月日（西暦/和暦）+ 年齢自動計算
  - 住所、電話番号（ハイフン自動整形）
  - ADL（自立 / 要支援1〜2 / 要介護1〜5）
  - アレルギー、体重
  - 関係者（3名: 氏名 / 関係性 / 電話）
  - 既往症6枠 + かかりつけ（病院候補サジェスト + 自由入力許容）
- 概要_バイタル
  - 要請概要 / 本人主訴
  - 基本バイタル（最大3セット）
  - 所見（神経 / 循環器 / 呼吸器 / 消化器 / 外傷）
  - 変更がある所見のハイライト表示
- 患者サマリー
  - 基本情報、概要/主訴、バイタル、変更所見の一括確認
- 送信履歴
  - 事案に紐づく送信履歴表示（ステータス列あり）

### 1-3. 病院検索ページ（`/hospitals/search`）

- タブ構成
  - 検索条件
  - 検索結果
  - 送信履歴
- 検索条件
  - 共通診療科目カード（直近検索 / 市区名検索で共通利用）
  - 直近検索（住所 + 共通科目 + OR/AND）
  - 市区名検索（候補リスト選択 + 共通科目 + OR/AND）
  - 個別検索（病院名候補リスト選択）
- 検索結果
  - テーブル表示（20件ページング）
  - 列: 病院ID / 病院名 / 科目 / 住所 / 電話番号 / 距離
  - 上部右端「受入要請送信」ボタン
- 個別検索結果
  - 単一病院ダッシュボード表示
  - 診療科目カード（可: 白、不可: グレーアウト、押下でアクティブ表示）
  - 選択した科目を送信時に反映
- 受入要請フロー
  - 受入要請送信 -> 確認画面 -> 送信完了
  - 確認画面では患者サマリーを事案情報サマリーと同等構成で表示

## 2. DB構成（Neon / PostgreSQL）

### 2-1. 使用テーブル

- `hospitals`
- `emergency_teams`
- `cases`
- `medical_departments`
- `hospital_departments`

### 2-2. データ投入関連

- `scripts/load_neon_seed.py`
  - 病院CSV取り込み
  - 住所ジオコーディング（緯度経度）
  - 既存データ削除後の再投入
- `scripts/setup_departments.sql`
  - 診療科目マスタ作成（正式名称/略称）
- `scripts/seed_hospital_departments_demo.sql`
  - 病院-診療科目のデモ紐づけ
- `scripts/execute_sql.js`
  - SQL実行ユーティリティ

## 3. API

- `GET /api/hospitals/suggest?q=...`
  - 病院名候補サジェスト
- `POST /api/hospitals/recent-search`
  - 直近検索 / 市区名検索 / 個別検索の実行
- `GET /api/cases/send-history?caseId=...`
  - 事案の送信履歴取得
- `POST /api/cases/send-history`
  - 事案の送信履歴保存

## 4. 既知課題

- 一部ファイルで文字化けが発生している可能性がある（要 UTF-8 統一確認）
- 送信履歴ステータスは現状「初期値: 未読」のみで、更新UI未実装
- 個別検索の病院名あいまい一致ルール（同名・近似名）の精緻化余地あり
- 確認/完了画面の文言とレイアウトの細部チューニング余地あり

## 5. 今後の優先実装

1. 送信履歴ステータス更新機能（未読->既読->受入可能->搬送先決定、キャンセル）
2. ステータス変更時の監査ログ（更新者・更新時刻）追加
3. 受入要請通知のリアルタイム化（必要ならPusher等の導入）
4. 文字コードの全体点検（UTF-8統一）
5. E2Eテスト追加（検索->送信->履歴参照の主要導線）

## 7. デプロイメモ

- `.env.local` はテンプレート化済み
- Vercel では `DATABASE_URL` を必須設定する
- 機密情報は `.env.local` にコミットしない（`.gitignore` 済み）

## 6. 開発運用ルール（当面）

- UI 文言は日本語を標準とする
- 主要利用端末は iPad横 / PC（モバイル最適化は低優先）
- UI統一ルールは `docs/UI_RULES.md` を参照する
- 仕様追加時はこのドキュメントへ実装記録と未対応項目を追記する
